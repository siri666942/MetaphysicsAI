# 赛博算命 · 三层增强说明

依据《赛博算命的喂书方法》的思路，对玄学工具做了「知识库 + 逻辑链 + 工具」三层增强。

---

## 第一层：喂书（RAG 检索增强）

- **位置**：`backend/rag.py`、`backend/knowledge/`
- **作用**：根据用户问题从命理知识库检索相关片段，注入系统提示词，避免模型「瞎编」。
- **当前实现**：关键词/标签匹配（`knowledge/chunks/*.json`），无需向量库即可运行。
- **扩展**：在 `knowledge/chunks/` 下按 README 格式继续添加《渊海子平》《滴天髓》《子平真诠评注》等白话/注解数据块；若要语义检索，可在 `rag.py` 中接入 Chroma/FAISS 等向量库。

---

## 第二层：教逻辑（CoT 思维链）

- **位置**：`backend/app.py` 中的 `SYSTEM_PROMPT`
- **作用**：固化八字分析的**标准步骤**，严禁跳步。
- **SOP 步骤**：
  1. 定真假（节气、月令深浅）
  2. 找格局（月令透干）
  3. 看强弱（旺相休囚死、通根）
  4. 取用神（病药、调候等）
  5. 断大运（结合前四步看喜忌）

模型被要求按此顺序展开分析，并在回复中体现逻辑链。

---

## 第三层：给工具（Function Calling）

- **位置**：`backend/app.py` 中的 `DIVINATION_TOOLS`、`run_divination_tool()`、`chat()` 流程
- **作用**：排盘一律由代码计算（`lunar_python`），AI 只负责解读，不自行推算八字/卦象。
- **工具**：
  - `get_bazi(year, month, day, hour?, minute?, is_male?, is_solar?)`：八字排盘
  - `get_meihua(numbers? | by_time?)`：梅花易数
  - `get_liuyao(numbers? | by_time?)`：六爻排卦

用户说「我是 1990 年 5 月 1 日出生的」时，模型会先调用 `get_bazi`，再用返回的排盘结果做分析。

---

## 小结

- **喂书**：知识库在 `backend/knowledge/`，检索逻辑在 `rag.py`，按需扩展 chunk 与向量检索。
- **逻辑链**：八字分析 SOP 已写进系统提示词，分析步骤更规范。
- **工具**：对话中已接入 Function Calling，排盘由后端精确计算，再交给模型解读。

一句话：把古籍变成「可查的字典」（RAG），用代码保证排盘准确（Tools），用思维链约束分析步骤（CoT）。
